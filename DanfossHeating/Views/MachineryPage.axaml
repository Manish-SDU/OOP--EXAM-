<UserControl
    x:Class="DanfossHeating.Views.MachineryPage"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="using:DanfossHeating.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:DanfossHeating.ViewModels"
    xmlns:views="using:DanfossHeating.Views"
    d:DesignHeight="450"
    d:DesignWidth="800"
    x:DataType="vm:MachineryViewModel"
    x:Name="MachineryPageControl"
    mc:Ignorable="d">

    <UserControl.Resources>
        <converters:BoolToColorConverter
            x:Key="BoolToColorConverter"
            FalseValue="Black"
            TrueValue="White" />
            
        <!-- Add the number converter -->
        <converters:StringToNumberConverter x:Key="StringToNumberConverter" />
            
        <!-- Style for the editable text boxes - simplified -->
        <Style x:Key="EditableValueTextBox" Selector="TextBox">
            <Setter Property="HorizontalAlignment" Value="Right"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Width" Value="100"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="4,1"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="3"/>
            <Setter Property="Margin" Value="5,0,0,0"/>
        </Style>
    </UserControl.Resources>

    <!-- Background based on theme (light/dark) -->
    <UserControl.Background>
        <SolidColorBrush Color="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#1E1E1E:#F0F0F0'}" />
    </UserControl.Background>    <Grid>
        <!-- Machinery Image -->
        <Image 
            Source="/Assets/Danffy/machinery.png"
            Width="270"
            Height="800"
            Margin="0,0,0,20"
            VerticalAlignment="Bottom"
            HorizontalAlignment="Left"
            ZIndex="99" />

        <!-- Header Panel with Accent Background -->
        <Border
            Height="70"
            VerticalAlignment="Top"
            Background="#D40000"
            BoxShadow="0 2 10 0 #40000000"
            ZIndex="10">
            <Grid>
                <!-- User Profile (Left) -->
                <StackPanel
                    Margin="20,0,0,0"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Center"
                    Orientation="Horizontal">
                    <!-- Profile Circle -->
                    <Border
                        Width="50"
                        Height="50"
                        Background="#D40000"
                        BorderBrush="#FFFFFF"
                        BorderThickness="2"
                        BoxShadow="0 2 8 0 #40000000"
                        CornerRadius="25">
                        <TextBlock
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            FontSize="24"
                            FontWeight="Bold"
                            Foreground="White"
                            Text="{Binding UserInitial}" />
                    </Border>

                    <!-- User Name -->
                    <TextBlock
                        Margin="10,0,0,0"
                        VerticalAlignment="Center"
                        FontSize="20"
                        FontWeight="SemiBold"
                        Foreground="White"
                        Text="{Binding UserName}" />
                </StackPanel>

                <!-- Theme Toggle (Right) -->
                <Button
                    Width="50"
                    Height="50"
                    Margin="0,0,20,0"
                    Padding="6"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Center"
                    Background="#20FFFFFF"
                    BorderBrush="#40FFFFFF"
                    BorderThickness="1"
                    Command="{Binding ToggleThemeCommand}"
                    CornerRadius="25">
                    <Panel>
                        <!-- Light Theme Icon (Sun) - shown when in dark mode -->
                        <PathIcon
                            Width="30"
                            Height="30"
                            Data="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41.39.39 1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39-.39-.39 1.03 0 1.41.39.39 1.03.39 1.41 0l1.06-1.06z"
                            Foreground="#FFFF00"
                            IsVisible="{Binding IsDarkTheme}" />

                        <!-- Dark Theme Icon (Moon) - shown when in light mode -->
                        <PathIcon
                            Width="30"
                            Height="30"
                            Data="M9.37 5.51c-.18.64-.27 1.31-.27 1.99 0 4.08 3.32 7.4 7.4 7.4.68 0 1.35-.09 1.99-.27C17.45 17.19 14.93 19 12 19c-3.86 0-7-3.14-7-7 0-2.93 1.81-5.45 4.37-6.49zM12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"
                            Foreground="#004080"
                            IsVisible="{Binding !IsDarkTheme}" />
                    </Panel>
                </Button>
            </Grid>
        </Border>

        <!-- Main Content Area -->
        <Grid Margin="0,70,0,0">
            <!-- Navigation Menu -->
            <Border
                Width="240"
                HorizontalAlignment="Left"
                VerticalAlignment="Stretch"
                Background="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#252525:#F8F8F8'}"
                BorderBrush="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#40FFFFFF:#20000000'}"
                BorderThickness="0,0,1,0">
                <StackPanel Margin="0,15,0,0" Spacing="2">
                    <!-- Home -->
                    <Button
                        Height="54"
                        Margin="8,3"
                        Padding="15,5"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Left"
                        Background="Transparent"
                        BorderThickness="0"
                        Command="{Binding NavigateToHomeCommand}"
                        CornerRadius="8">
                        <StackPanel Orientation="Horizontal">
                            <PathIcon
                                Width="22"
                                Height="22"
                                Data="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"
                                Foreground="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#E0E0E0:#333333'}" />
                            <TextBlock
                                Margin="15,0,0,0"
                                VerticalAlignment="Center"
                                FontSize="16"
                                FontWeight="Normal"
                                Foreground="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#E0E0E0:#333333'}"
                                Text="Home" />
                        </StackPanel>
                    </Button>

                    <!-- Optimizer -->
                    <Button
                        Height="54"
                        Margin="8,3"
                        Padding="15,5"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Left"
                        Background="Transparent"
                        BorderThickness="0"
                        Command="{Binding NavigateToOptimizerCommand}"
                        CornerRadius="8">
                        <StackPanel Orientation="Horizontal">
                            <PathIcon
                                Width="22"
                                Height="22"
                                Data="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"
                                Foreground="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#E0E0E0:#333333'}" />
                            <TextBlock
                                Margin="15,0,0,0"
                                VerticalAlignment="Center"
                                FontSize="16"
                                FontWeight="Normal"
                                Foreground="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#E0E0E0:#333333'}"
                                Text="Optimizer" />
                        </StackPanel>
                    </Button>

                    <!-- Machinery -->
                    <Button
                        Height="54"
                        Margin="8,3"
                        Padding="15,5"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Left"
                        Background="#D40000"
                        BorderThickness="0"
                        CornerRadius="8">
                        <Button.Effect>
                            <DropShadowEffect
                                BlurRadius="10"
                                OffsetX="0"
                                OffsetY="2"
                                Color="#40D40000" />
                        </Button.Effect>
                        <StackPanel Orientation="Horizontal">
                            <PathIcon
                                Width="22"
                                Height="22"
                                Data="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"
                                Foreground="White" />
                            <TextBlock
                                Margin="15,0,0,0"
                                VerticalAlignment="Center"
                                FontSize="16"
                                FontWeight="SemiBold"
                                Foreground="White"
                                Text="Machinery" />
                        </StackPanel>
                    </Button>

                    <!-- About Us -->
                    <Button
                        Height="54"
                        Margin="8,3"
                        Padding="15,5"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Left"
                        Background="Transparent"
                        BorderThickness="0"
                        Command="{Binding NavigateToAboutUsCommand}"
                        CornerRadius="8">
                        <StackPanel Orientation="Horizontal">
                            <PathIcon
                                Width="22"
                                Height="22"
                                Data="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,17H13V11H11V17Z"
                                Foreground="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#E0E0E0:#333333'}" />
                            <TextBlock
                                Margin="15,0,0,0"
                                VerticalAlignment="Center"
                                FontSize="16"
                                FontWeight="Normal"
                                Foreground="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#E0E0E0:#333333'}"
                                Text="About Us" />
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Border>

            <!-- Content Area -->
            <Border
                Margin="260,20,20,20"
                Padding="20"
                Background="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#252525:#FFFFFF'}"
                BorderBrush="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#40FFFFFF:#20000000'}"
                BorderThickness="1"
                BoxShadow="0 2 10 0 #30000000"
                CornerRadius="8">

                <Grid RowDefinitions="Auto,*">
                    <!-- Title Section -->
                    <Grid Grid.Row="0" Margin="0,0,0,20">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Title -->
                        <TextBlock 
                            Grid.Row="0"
                            Text="Machinery Overview" 
                            FontSize="28" 
                            FontWeight="SemiBold" 
                            HorizontalAlignment="Center"
                            Foreground="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#E0E0E0:#333333'}" />
                        
                        <!-- Subtitle -->
                        <TextBlock 
                            Grid.Row="1"
                            Text="Configure and manage your machinery settings" 
                            FontSize="14" 
                            Margin="0,5,0,15"
                            HorizontalAlignment="Center"
                            Foreground="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#B0B0B0:#666666'}" />
                        
                        <!-- Danfoss Info Banner -->
                        <Border 
                            Grid.Row="2"
                            Background="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#402020:#FFF0F0'}"
                            BorderBrush="#D40000"
                            BorderThickness="1"
                            CornerRadius="6"
                            Padding="15,12"
                            Margin="0,0,0,15"
                            BoxShadow="0 2 8 0 #30D40000"
                            IsVisible="{Binding ShowDanfossInfoBanner}">
                            
                            <Grid ColumnDefinitions="Auto,*,Auto">
                                <!-- Info Icon -->
                                <TextBlock Grid.Column="0" 
                                           Text="ðŸ’¡" 
                                           FontSize="18"
                                           Margin="0,0,10,0"
                                           VerticalAlignment="Center"/>
                                
                                <!-- Notification Message -->
                                <TextBlock Grid.Column="1" 
                                           Text="Tip: Check the box below to load realistic machine values provided by Danfoss. To enter custom values, simply uncheck the box and edit them manually. Remember to click (Save Changes) after editing." 
                                           TextWrapping="Wrap"
                                           VerticalAlignment="Center"
                                           FontSize="13"
                                           Foreground="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FFFFFF:#333333'}"/>
                                
                                <!-- Dismiss Button -->
                                <Button Grid.Column="2" 
                                        Command="{Binding DismissDanfossInfoCommand}"
                                        Content="âœ•"
                                        FontSize="14"
                                        Padding="8,2"
                                        Margin="10,0,0,0"
                                        Background="Transparent"
                                        Foreground="#D40000"
                                        BorderThickness="0"
                                        CornerRadius="4"
                                        VerticalAlignment="Center"
                                        HorizontalAlignment="Right"/>
                            </Grid>
                        </Border>
                        
                        <!-- Simplified Danfoss Values Selector -->
                        <Border 
                            Grid.Row="3"
                            Background="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#252525:#F5F5F5'}"
                            BorderBrush="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#444444:#DDDDDD'}"
                            BorderThickness="1"
                            CornerRadius="6"
                            Padding="15,10"
                            Width="280"
                            HorizontalAlignment="Center">
                            
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="8">
                                <CheckBox x:Name="DanfossValuesCheckbox"
                                         VerticalAlignment="Center"
                                         Foreground="#D40000"
                                         BorderBrush="#D40000"
                                         IsChecked="{Binding IsDanfossValuesSelected}"
                                         Background="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#252525:#FFFFFF'}">
                                    <TextBlock Text="Load Danfoss Default Values" 
                                               VerticalAlignment="Center"
                                               FontSize="14"
                                               FontWeight="SemiBold"
                                               Foreground="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#E0E0E0:#333333'}"/>
                                </CheckBox>
                                
                                <!-- Enhanced Info Button -->
                                <Button Name="InfoButton"
                                        Width="28"
                                        Height="28"
                                        Padding="0"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        VerticalAlignment="Center"
                                        ToolTip.Tip="Click for more information">
                                    <Button.Styles>
                                        <Style Selector="Button">
                                            <Setter Property="Opacity" Value="0.9"/>
                                            <Setter Property="RenderTransform" Value="scale(1)"/>
                                            <Setter Property="Transitions">
                                                <Transitions>
                                                    <TransformOperationsTransition Property="RenderTransform" Duration="0.2"/>
                                                    <DoubleTransition Property="Opacity" Duration="0.2"/>
                                                </Transitions>
                                            </Setter>
                                            <!-- Enhanced Pulsing Animation -->
                                            <Style.Animations>
                                                <Animation Duration="0:0:2.5" IterationCount="INFINITE">
                                                    <KeyFrame Cue="0%">
                                                        <Setter Property="Opacity" Value="0.9"/>
                                                    </KeyFrame>
                                                    <KeyFrame Cue="50%">
                                                        <Setter Property="Opacity" Value="1"/>
                                                    </KeyFrame>
                                                    <KeyFrame Cue="100%">
                                                        <Setter Property="Opacity" Value="0.9"/>
                                                    </KeyFrame>
                                                </Animation>
                                            </Style.Animations>
                                        </Style>
                                        <Style Selector="Button:pointerover">
                                            <Setter Property="Background" Value="Transparent"/>
                                            <Setter Property="Cursor" Value="Help"/>
                                            <Setter Property="RenderTransform" Value="scale(1.15)"/>
                                            <Setter Property="Opacity" Value="1"/>
                                        </Style>
                                        <Style Selector="Button:pressed">
                                            <Setter Property="RenderTransform" Value="scale(0.95)"/>
                                        </Style>
                                    </Button.Styles>
                                    <Border
                                        Width="28"
                                        Height="28"
                                        Background="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#402020:#FFF0F0'}"
                                        BorderBrush="#D40000"
                                        BorderThickness="1"
                                        CornerRadius="14">
                                        <PathIcon
                                            Width="18"
                                            Height="18"
                                            Data="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,17H13V11H11V17Z"
                                            Foreground="#D40000"/>
                                    </Border>
                                </Button>

                                <!-- Popup with enhanced styling -->
                                <Popup Name="InfoPopup"
                                       Placement="Right"
                                       HorizontalOffset="10"
                                       IsLightDismissEnabled="True">
                                    <Border
                                        Background="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#2A2A2A:#FFFFFF'}"
                                        BorderBrush="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#444444:#DDDDDD'}"
                                        BorderThickness="1"
                                        CornerRadius="8"
                                        Padding="20"
                                        Width="300"
                                        BoxShadow="0 4 16 0 #40000000">
                                        <Border.Transitions>
                                            <Transitions>
                                                <DoubleTransition Property="Opacity" Duration="0.2"/>
                                                <TransformOperationsTransition Property="RenderTransform" Duration="0.2"/>
                                            </Transitions>
                                        </Border.Transitions>
                                        <StackPanel Spacing="16">
                                            <!-- Title -->
                                            <TextBlock
                                                Text="Why Some Machines Don't Have Certain Values Available"
                                                FontSize="15"
                                                FontWeight="SemiBold"
                                                Foreground="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FFFFFF:#333333'}"
                                                TextWrapping="Wrap"/>

                                            <!-- Sections with subtle backgrounds -->
                                            <Border
                                                Background="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#333333:#F8F8F8'}"
                                                CornerRadius="6"
                                                Padding="14">
                                                <StackPanel Spacing="8">
                                                    <TextBlock
                                                        Text="Boilers (GB1, GB2, OB1):"
                                                        FontWeight="SemiBold"
                                                        FontSize="13"
                                                        Foreground="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FFFFFF:#333333'}"/>
                                                    <TextBlock
                                                        Text="Boilers generate heat from burning fuel (gas or oil) and do not require electricity for their operation, so they don't have electricity usage values."
                                                        TextWrapping="Wrap"
                                                        FontSize="13"
                                                        LineHeight="18"
                                                        Foreground="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#B0B0B0:#666666'}"/>
                                                </StackPanel>
                                            </Border>

                                            <Border
                                                Background="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#333333:#F8F8F8'}"
                                                CornerRadius="6"
                                                Padding="14">
                                                <StackPanel Spacing="8">
                                                    <TextBlock
                                                        Text="Heat Pump (HP1):"
                                                        FontWeight="SemiBold"
                                                        FontSize="13"
                                                        Foreground="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FFFFFF:#333333'}"/>
                                                    <TextBlock
                                                        Text="Heat pumps use electricity to transfer heat from the environment, but they do not have CO2 emissions or fuel consumption."
                                                        TextWrapping="Wrap"
                                                        FontSize="13"
                                                        LineHeight="18"
                                                        Foreground="{Binding IsDarkTheme, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#B0B0B0:#666666'}"/>
                                                </StackPanel>
                                            </Border>

                                            <!-- Close Button -->
                                            <Button
                                                HorizontalAlignment="Right"
                                                Padding="16,8"
                                                Background="#D40000"
                                                Foreground="White"
                                                BorderThickness="0"
                                                CornerRadius="4"
                                                Click="CloseInfoPopup_Click">
                                                <Button.Styles>
                                                    <Style Selector="Button">
                                                        <Setter Property="Transitions">
                                                            <Transitions>
                                                                <TransformOperationsTransition Property="RenderTransform" Duration="0.15"/>
                                                            </Transitions>
                                                        </Setter>
                                                    </Style>
                                                    <Style Selector="Button:pointerover">
                                                        <Setter Property="Background" Value="#E60000"/>
                                                        <Setter Property="Cursor" Value="Hand"/>
                                                        <Setter Property="RenderTransform" Value="scale(1.02)"/>
                                                    </Style>
                                                    <Style Selector="Button:pressed">
                                                        <Setter Property="RenderTransform" Value="scale(0.98)"/>
                                                    </Style>
                                                </Button.Styles>
                                                <TextBlock Text="Got it" FontWeight="Medium"/>
                                            </Button>
                                        </StackPanel>
                                    </Border>
                                </Popup>
                            </StackPanel>
                        </Border>
                    </Grid>
                    
                    <ScrollViewer
                        Grid.Row="1"
                        Margin="0"
                        HorizontalScrollBarVisibility="Auto"
                        VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding Machines}" 
                                      x:Name="MachinesItemsControl">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <!-- Maintain original 3 columns layout -->
                                    <UniformGrid Columns="3" HorizontalAlignment="Center" Margin="0" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border
                                        Width="280"
                                        Margin="10,10,10,20"
                                        Background="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#1A1A1A:#F5F5F5'}"
                                        BorderBrush="#D40000"
                                        BorderThickness="0,0,0,3"
                                        BoxShadow="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='0 4 15 0 #60000000:0 4 15 0 #25000000'}"
                                        CornerRadius="8">
                                        <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto">
                                            <!-- Warning Banner -->
                                            <Border 
                                                Grid.Row="0"
                                                Background="#FFEEEE"
                                                BorderBrush="#D40000"
                                                BorderThickness="0,0,0,1"
                                                Padding="10"
                                                CornerRadius="8,8,0,0"
                                                IsVisible="False"
                                                Name="ValidationBanner">
                                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                    <PathIcon
                                                        Width="16"
                                                        Height="16"
                                                        Data="M12,2L1,21H23M12,6L19.53,19H4.47M11,10V14H13V10M11,16V18H13V16"
                                                        Foreground="#D40000"
                                                        Margin="0,0,8,0" />
                                                    <TextBlock
                                                        x:Name="ValidationMessage"
                                                        Text="Invalid input: Please enter a valid number"
                                                        FontSize="12"
                                                        Foreground="#D40000"
                                                        VerticalAlignment="Center"
                                                        TextWrapping="Wrap" />
                                                </StackPanel>
                                            </Border>

                                            <!-- Machine Image Container -->
                                            <Border 
                                                Grid.Row="1"
                                                Height="160"
                                                Background="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#212121:#F0F0F0'}"
                                                CornerRadius="{Binding Path=IsVisible, ElementName=ValidationBanner, Converter={StaticResource BoolToColorConverter}, ConverterParameter='0,0,0,0:8,8,0,0'}"
                                                Classes="ImageBorder"
                                                ClipToBounds="True">
                                                <!-- Use a Grid to allow overlay -->
                                                <Grid>
                                                    <Image 
                                                        Source="{Binding ImagePath}"
                                                        Stretch="UniformToFill"
                                                        HorizontalAlignment="Center"
                                                        VerticalAlignment="Center" />
                                                    
                                                    <!-- Disabled Text Overlay -->
                                                    <TextBlock
                                                        x:Name="DisabledOverlayText"
                                                        Text="Disabled"
                                                        FontSize="24"
                                                        FontWeight="Bold"
                                                        Foreground="Red"
                                                        Background="#80FFFFFF"
                                                        HorizontalAlignment="Center"
                                                        VerticalAlignment="Center"
                                                        IsVisible="False" /> 
                                                </Grid>
                                            </Border>

                                            <!-- Machine Title -->
                                            <Grid Grid.Row="2" Margin="15,15">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <Grid>
                                                    <Border
                                                        Width="36"
                                                        Height="36"
                                                        Background="#D40000"
                                                        CornerRadius="18"
                                                        VerticalAlignment="Center"
                                                        Opacity="0.2"/>
                                                    <PathIcon
                                                        Width="20"
                                                        Height="20"
                                                        Data="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"
                                                        Foreground="#D40000"/>
                                                </Grid>
                                                
                                                <StackPanel Grid.Column="1" Margin="8,0,0,0" Spacing="2">
                                                    <TextBlock
                                                        VerticalAlignment="Center"
                                                        FontSize="16"
                                                        FontWeight="Bold"
                                                        Foreground="#D40000"
                                                        Text="{Binding Name}"/>
                                                    <TextBlock
                                                        VerticalAlignment="Center"
                                                        FontSize="12"
                                                        Foreground="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#B0B0B0:#666666'}"
                                                        Text="{Binding Name, Converter={x:Static vm:MachineryViewModel.MachineTypeNameConverter}}"/>
                                                </StackPanel>
                                            </Grid>

                                            <!-- Machine Data -->
                                            <Grid Grid.Row="3" Margin="12,0,12,12" RowDefinitions="Auto,Auto,Auto,Auto,Auto">
                                                <!-- Heat Output MW -->
                                                <Grid Grid.Row="0" Margin="0,0,0,8">
                                                    <TextBlock
                                                        FontSize="12"
                                                        Foreground="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#DDDDDD:#666666'}"
                                                        Text="Heat Output"
                                                        VerticalAlignment="Center"/>
                                                    <TextBox
                                                        HorizontalAlignment="Right"
                                                        VerticalAlignment="Center"
                                                        Width="90"
                                                        Height="28"
                                                        FontSize="13"
                                                        FontWeight="SemiBold"
                                                        Padding="4,1"
                                                        BorderThickness="1"
                                                        CornerRadius="3"
                                                        Name="HeatOutputTextBox"
                                                        Text="{Binding MaxHeat, Mode=TwoWay, Converter={StaticResource StringToNumberConverter}}"
                                                        LostFocus="NumericTextBox_LostFocus"
                                                        TextInput="NumericTextBox_TextInput"
                                                        Background="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#2A2A2A:#FFFFFF'}"
                                                        Foreground="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FFFFFF:#333333'}"
                                                        BorderBrush="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#444444:#CCCCCC'}"
                                                        ToolTip.Tip="Measured in MW"
                                                        />
                                                </Grid>

                                                <!-- Electricity Usage -->
                                                <Grid Grid.Row="1" Margin="0,0,0,8">
                                                    <TextBlock
                                                        FontSize="12"
                                                        Foreground="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#DDDDDD:#666666'}"
                                                        Text="Electricity Usage"
                                                        VerticalAlignment="Center"/>
                                                    <TextBox
                                                        HorizontalAlignment="Right"
                                                        VerticalAlignment="Center"
                                                        Width="90"
                                                        Height="28"
                                                        FontSize="13"
                                                        FontWeight="SemiBold"
                                                        Padding="4,1"
                                                        BorderThickness="1"
                                                        CornerRadius="3"
                                                        Name="ElectricityUsageTextBox"
                                                        Text="{Binding MaxElectricity, Mode=TwoWay, Converter={StaticResource StringToNumberConverter}}"
                                                        LostFocus="NumericTextBox_LostFocus"
                                                        TextInput="NumericTextBox_TextInput"
                                                        Background="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#2A2A2A:#FFFFFF'}"
                                                        Foreground="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FFFFFF:#333333'}"
                                                        BorderBrush="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#444444:#CCCCCC'}"
                                                        ToolTip.Tip="Measured in MW"
                                                        />
                                                </Grid>

                                                <!-- CO2 Emissions -->
                                                <Grid Grid.Row="2" Margin="0,0,0,8">
                                                    <TextBlock
                                                        FontSize="12"
                                                        Foreground="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#DDDDDD:#666666'}"
                                                        Text="COâ‚‚ Emissions"
                                                        VerticalAlignment="Center"/>
                                                    <TextBox
                                                        HorizontalAlignment="Right"
                                                        VerticalAlignment="Center"
                                                        Width="90"
                                                        Height="28"
                                                        FontSize="13"
                                                        FontWeight="SemiBold"
                                                        Padding="4,1"
                                                        BorderThickness="1"
                                                        CornerRadius="3"
                                                        Name="CO2EmissionsTextBox"
                                                        Text="{Binding CO2Emissions, Mode=TwoWay, Converter={StaticResource StringToNumberConverter}}"
                                                        LostFocus="NumericTextBox_LostFocus"
                                                        TextInput="NumericTextBox_TextInput"
                                                        Background="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#2A2A2A:#FFFFFF'}"
                                                        Foreground="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FFFFFF:#333333'}"
                                                        BorderBrush="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#444444:#CCCCCC'}"
                                                        ToolTip.Tip="Measured in kg/MWh"
                                                        />
                                                </Grid>

                                                <!-- Production Costs -->
                                                <Grid Grid.Row="3" Margin="0,0,0,8">
                                                    <TextBlock
                                                        FontSize="12"
                                                        Foreground="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#DDDDDD:#666666'}"
                                                        Text="Production Costs"
                                                        VerticalAlignment="Center"/>
                                                    <TextBox
                                                        HorizontalAlignment="Right"
                                                        VerticalAlignment="Center"
                                                        Width="90"
                                                        Height="28"
                                                        FontSize="13"
                                                        FontWeight="SemiBold"
                                                        Padding="4,1"
                                                        BorderThickness="1"
                                                        CornerRadius="3"
                                                        Name="ProductionCostsTextBox"
                                                        Text="{Binding ProductionCosts, Mode=TwoWay, Converter={StaticResource StringToNumberConverter}}"
                                                        LostFocus="NumericTextBox_LostFocus"
                                                        TextInput="NumericTextBox_TextInput"
                                                        Background="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#2A2A2A:#FFFFFF'}"
                                                        Foreground="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FFFFFF:#333333'}"
                                                        BorderBrush="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#444444:#CCCCCC'}"
                                                        ToolTip.Tip="Measured in DKK/MWh"
                                                        />
                                                </Grid>

                                                <!-- Fuel Consumption -->
                                                <Grid Grid.Row="4">
                                                    <TextBlock
                                                        FontSize="12"
                                                        Foreground="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#DDDDDD:#666666'}"
                                                        Text="Fuel Consumption"
                                                        VerticalAlignment="Center"/>
                                                    <TextBox
                                                        HorizontalAlignment="Right"
                                                        VerticalAlignment="Center"
                                                        Width="90"
                                                        Height="28"
                                                        FontSize="13"
                                                        FontWeight="SemiBold"
                                                        Padding="4,1"
                                                        BorderThickness="1"
                                                        CornerRadius="3"
                                                        Name="FuelConsumptionTextBox"
                                                        Text="{Binding FuelConsumption, Mode=TwoWay, Converter={StaticResource StringToNumberConverter}}"
                                                        LostFocus="NumericTextBox_LostFocus"
                                                        TextInput="NumericTextBox_TextInput"
                                                        Background="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#2A2A2A:#FFFFFF'}"
                                                        Foreground="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FFFFFF:#333333'}"
                                                        BorderBrush="{Binding Path=(views:MachineryPage.IsDarkTheme), ElementName=MachineryPageControl, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#444444:#CCCCCC'}"
                                                        ToolTip.Tip="Measured in MWh/MWh"
                                                        />
                                                </Grid>
                                            </Grid>
                                            
                                            <!-- Save Button -->
                                            <Button 
                                                Grid.Row="4"
                                                Margin="12,0,12,12"
                                                HorizontalAlignment="Stretch"
                                                HorizontalContentAlignment="Center"
                                                Background="#D40000"
                                                Foreground="White"
                                                CornerRadius="4"
                                                Padding="0,8"
                                                x:Name="SaveButton"
                                                Click="SaveButton_Click"
                                                Tag="{Binding}">
                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                    <PathIcon
                                                        Width="16"
                                                        Height="16"
                                                        Data="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"
                                                        Foreground="White" />
                                                    <TextBlock Text="Save Changes" />
                                                </StackPanel>
                                            </Button>
                                            
                                            <!-- Disable Button -->
                                            <Button 
                                                Grid.Row="5"
                                                Margin="12,0,12,12"
                                                HorizontalAlignment="Stretch"
                                                HorizontalContentAlignment="Center"
                                                Background="#707070"
                                                Foreground="White"
                                                CornerRadius="4"
                                                Padding="0,8"
                                                x:Name="DisableEnableButton"
                                                Click="ToggleEnableButton_Click"
                                                Tag="{Binding}">
                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                    <PathIcon
                                                        Width="16"
                                                        Height="16"
                                                        Data="M19,13H5V11H19V13Z"
                                                        Foreground="White" />
                                                    <TextBlock x:Name="ToggleButtonText" Text="Disable Machine" />
                                                </StackPanel>
                                            </Button>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</UserControl>